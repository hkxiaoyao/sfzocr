# Context
Filename: sfzocr_memory_issue_analysis.md
Created On: 2024-12-26
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
用户反映OCR系统部署到服务器后内存占用非常高，4h4g配置请求几次接口就崩溃了，怀疑可能存在线程没有释放或其他内存泄漏问题。需要分析代码中的资源管理、线程处理、图像处理等可能导致内存问题的模块。

# Project Overview
这是一个基于Python的OCR (光学字符识别) 系统，包含：
- FastAPI web接口
- 图像处理模块
- OCR引擎
- 并发处理工具
- 日志系统

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)

## 内存问题根本原因分析

### 1. 多重进程池导致的内存放大效应
**核心问题**: 双层进程池架构导致内存使用量呈几何级数增长
- Uvicorn配置了4个worker进程 (WORKERS=4)
- 每个worker又创建了一个ProcessPoolExecutor，配置4个进程 (OCR_PROCESS_POOL_SIZE=4)
- 总计最多16个进程同时运行 (4 × 4 = 16)
- 每个进程都会独立加载PaddleOCR模型，造成内存重复占用

### 2. PaddleOCR模型内存占用巨大
**发现**: 每个进程的OCR引擎实例都会加载完整的模型集
- PaddleOCR需要加载文本检测、识别、方向分类三个深度学习模型
- 单个进程的模型内存占用约200-800MB
- 16个进程总内存占用: 16 × 500MB ≈ 8GB (远超4GB配置)

### 3. 图像处理内存泄漏点
**位置**: app/core/image_processor.py 和 app/core/ocr_engine.py
- Base64解码创建大量临时字节对象 (`decode_image()`)
- OpenCV图像处理产生多个数组副本 (`enhance_image()`, `resize_image()`)
- PIL与OpenCV之间的格式转换 (`encode_image_to_base64()`)
- 复杂的图像预处理流程创建多个中间结果
- 这些临时对象可能没有及时被垃圾回收

### 4. 并发处理加剧内存压力
**位置**: app/api/endpoints.py 批量处理接口
- 批量接口使用 `asyncio.gather()` 并发处理多张图片
- 单个请求可能同时处理正反面图片，瞬间内存使用翻倍
- 多个用户同时调用接口时，内存压力叠加

### 5. 资源释放机制不完善
**发现**: 缺乏主动的内存管理
- OCR引擎实例只在进程退出时清理 (`atexit.register`)
- 没有定期的垃圾回收机制
- 没有内存使用监控和告警

### 6. 关键配置文件分析
- **进程配置**: WORKERS=4, OCR_PROCESS_POOL_SIZE=4 (内存杀手组合)
- **超时配置**: OCR_TASK_TIMEOUT=30秒 (进程可能长时间占用内存)
- **日志级别**: INFO (可优化为WARNING减少内存占用)

### 7. 依赖库版本问题
- PaddlePaddle 2.5.2 和 PaddleOCR 2.6.0.3 组合可能存在内存泄漏
- NumPy补丁代码表明存在兼容性问题，可能影响内存管理

## 内存使用估算
**保守估算**:
- 基础系统: ~500MB
- PaddleOCR模型 × 16进程: ~8GB  
- 图像处理缓存: ~500MB-1GB
- **总计**: ~9-10GB (4GB配置必然崩溃)

## 紧急程度评估
**高危**: 当前架构在4GB内存下不可持续运行，需要立即优化

# Proposed Solution (Populated by INNOVATE mode)

## 解决方案对比分析

### 方案一：进程池优化策略 ⭐⭐⭐⭐⭐
**实施难度**: 极低 | **效果**: 立竿见影 | **风险**: 极低
- 配置调整：WORKERS=1, OCR_PROCESS_POOL_SIZE=2
- 内存占用：从~8GB降至~1GB
- 适用场景：紧急处理，立即部署

### 方案二：模型共享架构重构 ⭐⭐⭐
**实施难度**: 高 | **效果**: 最佳 | **风险**: 中等
- 单例OCR引擎+线程池替代进程池
- 内存占用：~500MB
- 适用场景：长期优化，要求高并发

### 方案三：按需加载+内存池管理 ⭐⭐⭐⭐
**实施难度**: 中等 | **效果**: 良好 | **风险**: 低
- 智能资源管理+生命周期控制
- 内存占用：弹性可控
- 适用场景：中期优化，平衡性能与资源

### 方案四：轻量化图像处理流程 ⭐⭐⭐⭐
**实施难度**: 低 | **效果**: 中等 | **风险**: 低  
- 简化预处理+就地操作
- 内存节省：30-50%
- 适用场景：配合其他方案

### 方案五：微服务拆分 ⭐⭐
**实施难度**: 极高 | **效果**: 极佳 | **风险**: 高
- OCR引擎独立微服务
- 内存占用：彻底解决
- 适用场景：大规模部署，资源充足

## 推荐实施策略

### 阶段一：紧急救火（立即实施）
**目标**: 快速解决崩溃问题
**方案**: 方案一 + 方案四
- 进程配置优化
- 图像处理流程简化
- 预期效果：内存占用降至1.5GB以下

### 阶段二：稳定优化（1-2周）  
**目标**: 提升系统稳定性
**方案**: 方案三部分功能
- 内存监控告警
- 垃圾回收优化
- 图像处理内存池

### 阶段三：长期架构（1-2月）
**目标**: 支撑业务长期发展
**方案**: 根据业务需求选择方案二或方案五
- 高并发需求 → 方案二
- 大规模部署 → 方案五

## 最终推荐
**立即采用方案一+方案四**，这是在当前4GB内存限制下最快速有效的解决方案，可以立即停止崩溃问题。

# Implementation Plan (Generated by PLAN mode)

## 变更计划详情

### [变更计划]
- **文件**: app/config.py
- **理由**: 降低进程池配置，将内存占用从8GB降至1GB

- **文件**: app/core/image_processor.py  
- **理由**: 简化图像预处理流程，减少30-50%临时内存占用

- **文件**: app/core/ocr_engine.py
- **理由**: 添加显式垃圾回收和内存清理机制

- **文件**: app/utils/concurrency.py
- **理由**: 优化进程池管理，添加内存监控功能

- **文件**: run.py
- **理由**: 调整启动参数，确保低内存模式生效

## 实施检查清单

### 阶段一：紧急配置优化（立即生效）

1. 修改进程池核心配置参数
2. 降低worker进程数量为1
3. 降低OCR进程池大小为2
4. 添加内存使用环境变量控制
5. 简化图像预处理流程，跳过轮廓检测
6. 简化图像增强算法，使用快速版本
7. 添加显式垃圾回收调用
8. 优化base64解码流程，减少临时对象
9. 修改启动脚本，确保低内存配置生效
10. 添加进程池内存监控日志
11. 创建内存监控工具脚本
12. 更新配置文档和部署说明

### 阶段二：验证与监控（部署后）

13. 验证内存占用是否降低至预期范围
14. 测试OCR功能完整性
15. 检查响应时间是否在可接受范围
16. 监控系统稳定性

# Current Execution Step (Updated by EXECUTE mode when starting a step)
> 已完成: "深度修复: 地址提取全链路身份证号码过滤"

# Task Progress (Appended by EXECUTE mode after each step completion)

* 2024-12-26 [完成]
  * Step: 检查清单项目1-4 - 修改进程池核心配置参数
  * Modifications: 
    - app/config.py: WORKERS=4→1, OCR_PROCESS_POOL_SIZE=4→2, 添加内存优化配置项
    - 添加环境变量: MEMORY_OPTIMIZATION, MAX_CONCURRENT_REQUESTS, ENABLE_GC_AFTER_REQUEST
    - LOG_LEVEL从INFO改为WARNING以节省内存
  * Change Summary: 核心进程池配置大幅优化，预计内存占用从8GB降至1GB
  * Reason: 执行计划步骤1-4，解决双层进程池内存放大问题
  * Blockers: None
  * User Confirmation Status: [Pending Confirmation]

* 2024-12-26 [完成]
  * Step: 检查清单项目5-6 - 简化图像预处理流程
  * Modifications:
    - app/core/image_processor.py: 优化preprocess_id_card_image()方法
    - 添加内存优化模式判断，跳过复杂的图像增强
    - 降低最大处理尺寸到800px，添加显式垃圾回收
  * Change Summary: 图像处理内存占用预计减少30-50%
  * Reason: 执行计划步骤5-6，减少图像处理临时内存占用
  * Blockers: None
  * User Confirmation Status: [Pending Confirmation]

* 2024-12-26 [完成]
  * Step: 检查清单项目7-8 - 添加垃圾回收和内存清理
  * Modifications:
    - app/core/ocr_engine.py: extract_id_card_info()添加gc.collect()调用
    - 在OCR前后、函数结束和异常处理中都添加垃圾回收
    - 优化日志输出，内存优化模式下减少日志量
  * Change Summary: 改进内存清理机制，防止内存积累
  * Reason: 执行计划步骤7-8，主动释放不需要的内存
  * Blockers: None
  * User Confirmation Status: [Pending Confirmation]

* 2024-12-26 [完成]
  * Step: 检查清单项目9-10 - 修改启动脚本和添加内存监控
  * Modifications:
    - run.py: 强制使用单worker模式，降低日志级别
    - app/utils/concurrency.py: 添加内存监控功能_log_memory_usage()
    - 添加psutil依赖用于内存监控，在任务前后记录内存使用
  * Change Summary: 启动参数优化，实时内存监控能力
  * Reason: 执行计划步骤9-10，确保低内存配置生效并可监控
  * Blockers: None
  * User Confirmation Status: [Pending Confirmation]

* 2024-12-26 [完成]
  * Step: 检查清单项目11-12 - 创建监控工具和文档
  * Modifications:
    - 新增文件: memory_monitor.py (内存监控工具脚本)
    - 新增文件: MEMORY_OPTIMIZATION.md (部署说明文档)
    - requirements.txt: 添加psutil==5.9.6依赖
  * Change Summary: 完整的内存监控和部署文档体系
  * Reason: 执行计划步骤11-12，提供运维工具和文档支持
  * Blockers: None
  * User Confirmation Status: [Success]

* 2024-12-26 [完成]
  * Step: 紧急修复 - 地址提取逻辑错误（深度修复）
  * Modifications:
    - app/core/ocr_engine.py: 全面修复地址合并时身份证号码混入问题
    - 地址块收集阶段：优先排除身份证号码
    - 地址处理循环：添加身份证号码正则过滤
    - 门牌号查找：严格排除身份证号码，增加长度检查
    - 数字块查找：双重身份证号码验证
    - _post_process_address：村名和门牌号查找中排除身份证号码
    - _apply_address_rules：规则3中增强身份证号码检测
    - 强化_is_valid_address_text()函数，添加10位以上数字排除
  * Change Summary: 在地址处理的8个关键节点全面阻断身份证号码混入
  * Reason: 用户反馈地址仍包含身份证号码，进行深度全链路修复
  * Blockers: None
  * User Confirmation Status: [Pending Confirmation]

# Final Review (Populated by REVIEW mode)
[待填充] 