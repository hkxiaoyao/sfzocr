# 身份证OCR识别服务使用说明

## 项目介绍

这是一个基于Python开发的身份证OCR识别服务，可以通过API接口识别身份证上的文字信息，支持并发处理多个请求。

主要功能：
- 身份证正面识别（姓名、性别、民族、出生日期、住址、身份证号）
- 身份证背面识别（签发机关、有效期限）
- 支持批量识别多张身份证图片
- 提供REST API接口，方便集成到其他系统
- 支持Base64编码和文件上传两种方式提交图片

## 环境要求

- Python 3.7或更高版本
- Windows、Linux或macOS操作系统
- 至少2GB内存（推荐4GB或更多）

## 安装步骤

### 1. 安装Python环境

如果您还没有安装Python，请先从[Python官网](https://www.python.org/downloads/)下载并安装Python 3.7或更高版本。

### 2. 下载项目代码

将项目代码下载到本地，或者直接使用git克隆：

```bash
git clone https://github.com/yourusername/sfzocr.git
cd sfzocr
```

### 3. 安装依赖包

在项目根目录下执行以下命令安装所需的依赖包：

```bash
pip install -r requirements.txt
```

注意：安装过程可能需要几分钟时间，特别是PaddlePaddle和PaddleOCR这两个包比较大。

如果安装PaddlePaddle时遇到问题，可以参考[PaddlePaddle官方安装指南](https://www.paddlepaddle.org.cn/install/quick)，选择适合您系统的安装方式。

### 4. 创建必要的目录

服务会自动创建以下目录：
- `logs`：存放日志文件
- `models`：存放OCR模型文件（首次运行时会自动下载）

## 启动服务

### 开发环境启动

如果您是在开发环境中测试，建议使用调试模式启动：

```bash
cd sfzocr
python run.py --debug
```

调试模式特点：
- 只使用一个工作进程
- 代码修改后自动重新加载
- 更详细的日志输出

### 生产环境启动

在生产环境中，可以指定更多的工作进程来提高并发处理能力：

```bash
cd sfzocr
python run.py --host 0.0.0.0 --port 8080 --workers 4
```

参数说明：
- `--host`：服务监听的IP地址，0.0.0.0表示监听所有网络接口
- `--port`：服务监听的端口号
- `--workers`：工作进程数量，建议设置为CPU核心数
- `--debug`：是否启用调试模式（生产环境不建议使用）

## 使用API接口

服务启动后，可以通过以下方式使用API：

### 1. 查看API文档

在浏览器中访问：`http://服务器IP:端口/docs`

例如：`http://localhost:8000/docs`

这里提供了交互式的API文档，使用全中文界面，可以直接在页面上测试API功能。文档包含了所有API的详细说明、请求参数和响应格式。

如果您喜欢另一种文档风格，也可以访问：`http://服务器IP:端口/redoc`

例如：`http://localhost:8000/redoc`

### 2. 身份证识别API

#### 单张身份证识别 (Base64方式)

**请求地址**：`/api/v1/ocr/idcard`

**请求方法**：POST

**请求参数**：
```json
{
  "image": "base64编码的图片数据",
  "side": "front"  // 可选值：front（正面）、back（背面）
}
```

**响应结果**：
```json
{
  "code": 0,
  "message": "识别成功",
  "data": {
    "name": "张三",
    "sex": "男",
    "nation": "汉",
    "birth": "1990-01-01",
    "address": "北京市朝阳区...",
    "id_number": "110101199001010123",
    "issue_authority": null,
    "valid_period": null
  }
}
```

#### 单张身份证识别 (文件上传方式)

**请求地址**：`/api/v1/ocr/idcard/upload`

**请求方法**：POST

**请求参数**：
- `image`：上传的身份证图片文件（form-data格式）
- `side`：身份证正反面，可选值：front（正面）、back（背面）

**请求示例**：
```
curl -X POST "http://localhost:8000/api/v1/ocr/idcard/upload" \
  -H "accept: application/json" \
  -F "image=@/path/to/idcard.jpg" \
  -F "side=front"
```

**响应结果**：与Base64方式相同

#### 批量身份证识别 (Base64方式)

**请求地址**：`/api/v1/ocr/idcard/batch`

**请求方法**：POST

**请求参数**：
```json
{
  "images": [
    {
      "image": "base64编码的图片数据1",
      "side": "front"
    },
    {
      "image": "base64编码的图片数据2",
      "side": "back"
    }
  ]
}
```

**响应结果**：
```json
{
  "code": 0,
  "message": "处理完成，成功: 2/2",
  "data": [
    {
      "name": "张三",
      "sex": "男",
      "nation": "汉",
      "birth": "1990-01-01",
      "address": "北京市朝阳区...",
      "id_number": "110101199001010123",
      "issue_authority": null,
      "valid_period": null
    },
    {
      "name": null,
      "sex": null,
      "nation": null,
      "birth": null,
      "address": null,
      "id_number": null,
      "issue_authority": "北京市公安局",
      "valid_period": "2010.01.01-2020.01.01"
    }
  ],
  "failed_indices": []
}
```

#### 批量身份证识别 (文件上传方式)

**请求地址**：`/api/v1/ocr/idcard/batch/upload`

**请求方法**：POST

**请求参数**：
- `front_image`：上传的身份证正面图片文件（form-data格式，可选）
- `back_image`：上传的身份证背面图片文件（form-data格式，可选）

**请求示例**：
```
curl -X POST "http://localhost:8000/api/v1/ocr/idcard/batch/upload" \
  -H "accept: application/json" \
  -F "front_image=@/path/to/front.jpg" \
  -F "back_image=@/path/to/back.jpg"
```

**响应结果**：与Base64方式相同

### 3. 健康检查API

**请求地址**：`/api/v1/health`

**请求方法**：GET

**响应结果**：
```json
{
  "code": 0,
  "message": "服务正常",
  "data": {
    "status": "healthy",
    "version": "0.1.0",
    "timestamp": 1626345678
  }
}
```

## 使用测试脚本

项目提供了一个测试脚本`test_api.py`，可以用来测试API接口是否正常工作。

### 测试健康检查API

```bash
python test_api.py --health
```

### 测试单张身份证识别

```bash
# 测试身份证正面识别 (Base64方式)
python test_api.py --image 身份证正面图片路径.jpg --side front

# 测试身份证背面识别 (Base64方式)
python test_api.py --image 身份证背面图片路径.jpg --side back

# 测试身份证正面识别 (文件上传方式)
python test_api.py --image 身份证正面图片路径.jpg --side front --upload

# 测试身份证背面识别 (文件上传方式)
python test_api.py --image 身份证背面图片路径.jpg --side back --upload
```

### 测试批量身份证识别

```bash
# 测试批量身份证识别 (Base64方式)
python test_api.py --front 身份证正面图片路径.jpg --back 身份证背面图片路径.jpg

# 测试批量身份证识别 (文件上传方式)
python test_api.py --front 身份证正面图片路径.jpg --back 身份证背面图片路径.jpg --upload
```

### 自定义API地址

如果服务不是运行在默认地址，可以使用`--url`参数指定API地址：

```bash
python test_api.py --url http://服务器IP:端口/api/v1 --health
```

### 测试脚本帮助

查看测试脚本的完整帮助信息：

```bash
python test_api.py --help
```

## 图片要求

为了获得最佳识别效果，上传的身份证图片应满足以下要求：

1. 图片清晰，无严重模糊、反光
2. 身份证完整显示在图片中
3. 光线均匀，无过度曝光或过暗现象
4. 身份证尽量占据图片的主要部分

服务会对图片进行预处理（包括旋转校正、裁剪等），但原始图片质量仍然是影响识别准确率的关键因素。

## 常见问题解答

### 1. 服务启动失败

**问题**：运行`python run.py`后，服务无法正常启动。

**解决方法**：
- 检查日志文件（logs目录下）查看具体错误信息
- 确认所有依赖包已正确安装
- 确认Python版本是3.7或更高
- 如果是内存不足，可以尝试减少工作进程数量

### 2. 识别准确率不高

**问题**：身份证信息识别不准确或识别不全。

**解决方法**：
- 提高上传图片的质量和清晰度
- 确保身份证在图片中完整显示
- 避免图片中有复杂背景或其他干扰元素
- 调整光线，避免反光和阴影

### 3. 服务响应慢

**问题**：API请求响应时间过长。

**解决方法**：
- 增加工作进程数量（`--workers`参数）
- 减小上传图片的尺寸（建议不超过2000x2000像素）
- 升级服务器硬件配置，特别是增加内存和CPU核心数
- 检查网络连接是否稳定

### 4. 内存占用过高

**问题**：服务运行一段时间后内存占用过高。

**解决方法**：
- 减少OCR进程池大小，在环境变量中设置：`OCR_PROCESS_POOL_SIZE=1`
- 减少工作进程数量
- 定期重启服务
- 增加服务器内存

### 5. 上传图片失败

**问题**：使用Base64方式上传图片时出现编码错误。

**解决方法**：
- 尝试使用文件上传API（`/api/v1/ocr/idcard/upload`）代替Base64编码方式
- 确保Base64编码正确，不要包含换行符
- 检查图片格式是否支持（支持JPG、PNG、BMP等常见格式）

## 配置参数说明

可以通过环境变量或启动参数自定义服务配置：

### 环境变量配置

```bash
# 服务基本配置
export DEBUG=true          # 是否启用调试模式
export HOST=0.0.0.0        # 服务监听地址
export PORT=8080           # 服务监听端口
export WORKERS=4           # 工作进程数

# OCR配置
export OCR_MODEL_DIR=/path/to/models       # OCR模型目录
export OCR_PROCESS_POOL_SIZE=2             # OCR处理进程池大小
export OCR_TASK_TIMEOUT=30                 # OCR任务超时时间(秒)

# 日志配置
export LOG_LEVEL=INFO                      # 日志级别(DEBUG/INFO/WARNING/ERROR)
export LOG_DIR=/path/to/logs               # 日志目录
export LOG_FILENAME=sfzocr.log             # 日志文件名
export LOG_ROTATION="20 MB"                # 日志文件轮转大小
export LOG_RETENTION="1 week"              # 日志保留时间

# 安全配置
export API_KEYS=key1,key2,key3             # API密钥列表(逗号分隔)
```

### 启动参数配置

```bash
python run.py --host 0.0.0.0 --port 8080 --workers 4 --debug
```

## 技术支持

如果您在使用过程中遇到任何问题，可以通过以下方式获取帮助：

1. 查看日志文件，了解详细错误信息
2. 在GitHub项目页面提交Issue
3. 发送邮件至技术支持邮箱

## 许可证

本项目采用MIT许可证，详情请参阅LICENSE文件。 